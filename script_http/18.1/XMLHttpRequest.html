<!-- 使用XMLHttpRequest -->
<!DOCTYPE html>
<html>
<body>
	<p>XMLHttpRequest</p>

	<input type="file" data-uploadto></input>
</body>

<script type="text/javascript">
	// var request = new XMLHttpRequest();
	// console.log(request);

	// request.open('GET', './XMLHttpRequestStaticFile.html');
	// request.send(null);

	function postMessage(msg) {
		var request = new XMLHttpRequest();
		request.open("POST", "../../server.js");
		request.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
		request.send(msg);
	}
	
	// postMessage('me');


	function getText(url, callback) {
		var request = new XMLHttpRequest();
		request.open("GET", url);
		request.onreadystatechange = function() {
			if (request.readyState === 4 && request.status === 200) {
				var type = request.getResponseHeader("Content-Type");
				if (type.match(/^text/))
					callback(request.responseText);
			}
		};

		request.send(null);
	}

	getText('./XMLHttpRequestStaticFile.html', function(text) {
		console.log(text);
	});

	getText('./testText', function(text) {
		console.log(text);
	});


	function getTextSync(url) {
		var request = new XMLHttpRequest();
		request.open("GET", url, false); // Synchronous XMLHttpRequest on the main thread is deprecated because of its detrimental effects to the end user's experience.
		request.send(null);

		if (request.status !== 200)
			throw new Error(request.statusText);

		var type = request.getResponseHeader("Content-Type");
		if (!type.match(/^text/))
			throw new Error("Expected textual response; got: " + type);

		return request.responseText;
	}

	getTextSync('./XMLHttpRequestStaticFile.html');
	// getTextSync('./testJson.json'); // 报错


	function get(url, callback) {
		var request = new XMLHttpRequest();
		request.open("GET", url);
		request.onreadystatechange = function() {
			if (request.readyState === 4 && request.status === 200) {
				var type = request.getResponseHeader("Content-Type");
				if (type.indexOf('xml') !== -1 && request.responseXML)
					callback(request.responseXML);

				else if (type === "application/json")
					callback(JSON.parse(request.responseText));
				else
					callback(request.responseText);
			}
		};
		request.send(null);
	}
	get('testJson.json', function(content) {
		console.log(content);
	});


	// 用于HTTP请求的编码对象
	function encodeFormData(data) {
		if (!data)
			return "";

		var pairs = [];
		for (var name in data) {
			if (!data.hasOwnProperty(name))
				continue;

			if (typeof data[name] === "function")
				continue;

			var value = data[name].toString();
			name = encodeURIComponent(name.replace("%20", "+"));
			value = encodeURIComponent(value.replace("%20", "+"));
			pairs.push(name + "=" + value);
		}
		return pairs.join('&');
	}

	var a = encodeFormData({
		"name": "Bowen",
		"age": 23
	});

	console.log(a);


	function uploadFile() {
		var elts = document.getElementsByTagName("input");
		for (var i = 0; i < elts.length; i++) {
			var input = elts[i];
			if (input.type !== "file")
				continue;

			var url = input.getAttribute("data-uploadto");
			if (!url)
				continue;
			input.addEventListener("change", function() {
				var file = this.files[0];
				if (!file)
					return;

				var xhr = new XMLHttpRequest();
				xhr.open("POST", url);
				xhr.send(file);
			});
		}
	}




</script>

</html>

































